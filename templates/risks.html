{% extends "base.html" %}
{% block title %}Risk Register{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2><i class="bi bi-list-check me-2"></i>Risk Register</h2>
        <p class="text-muted">{{ risks|length }} risk items</p>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Asset</label>
                <select name="asset_id" class="form-select">
                    <option value="">All Assets</option>
                    {% for asset in assets %}
                    <option value="{{ asset.id }}" {% if filters.asset_id == asset.id %}selected{% endif %}>
                        {{ asset.name[:40] }}{% if asset.name|length > 40 %}...{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">STRIDE</label>
                <select name="stride_code" class="form-select">
                    <option value="">All</option>
                    {% for stride in stride_categories %}
                    <option value="{{ stride.code }}" {% if filters.stride_code == stride.code %}selected{% endif %}>
                        {{ stride.code }} - {{ stride.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Rating</label>
                <select name="rating_id" class="form-select">
                    <option value="">All Ratings</option>
                    {% for rating in ratings %}
                    <option value="{{ rating.id }}" {% if filters.rating_id == rating.id %}selected{% endif %}>
                        {{ rating.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="reviewed" {% if filters.status == 'reviewed' %}selected{% endif %}>Reviewed</option>
                    <option value="approved" {% if filters.status == 'approved' %}selected{% endif %}>Approved</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Finding #..." value="{{ filters.search or '' }}">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Risk Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-header">
                <tr>
                    <th style="width: 50px">#</th>
                    <th>Asset</th>
                    <th style="width: 60px">STRIDE</th>
                    <th>Finding</th>
                    <th>Severity</th>
                    <th>Pre-Risk</th>
                    <th>Post-Risk (2026)</th>
                    <th style="width: 100px">Status</th>
                    <th style="width: 80px">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for risk in risks %}
                <tr class="{% if risk.post_risk_rating and risk.post_risk_rating.name == 'Acceptable' %}risk-acceptable{% elif risk.post_risk_rating and risk.post_risk_rating.name == 'Mitigation Desirable' %}risk-mitigation{% elif risk.post_risk_rating and risk.post_risk_rating.name == 'Remediation Required' %}risk-remediation{% endif %}">
                    <td><strong>{{ risk.assessment_number }}</strong></td>
                    <td>
                        <small>{{ risk.asset.name[:35] }}{% if risk.asset.name|length > 35 %}...{% endif %}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary" title="{{ risk.stride.name if risk.stride else '' }}">
                            {{ risk.stride_code }}
                        </span>
                    </td>
                    <td><small>{{ risk.finding_number or '-' }}</small></td>
                    <td><small>{{ risk.severity.name if risk.severity else '-' }}</small></td>
                    <td><small>{{ risk.pre_risk_rating.name if risk.pre_risk_rating else '-' }}</small></td>
                    <td>
                        {% if risk.post_risk_rating %}
                            {% if risk.post_risk_rating.name == 'Acceptable' %}
                                <span class="badge bg-success">{{ risk.post_risk_rating.name }}</span>
                            {% elif risk.post_risk_rating.name == 'Mitigation Desirable' %}
                                <span class="badge bg-warning text-dark">{{ risk.post_risk_rating.name }}</span>
                            {% else %}
                                <span class="badge bg-danger">{{ risk.post_risk_rating.name }}</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-secondary">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if risk.review_status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% elif risk.review_status == 'reviewed' %}
                            <span class="badge bg-info">Reviewed</span>
                        {% else %}
                            <span class="badge bg-success">Approved</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('risk_detail', risk_id=risk.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        No risk items found matching your filters
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3 text-muted">
    <small>Showing {{ risks|length }} risk items</small>
</div>
{% endblock %}
